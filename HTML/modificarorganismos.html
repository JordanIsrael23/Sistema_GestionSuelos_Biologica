<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modificar Organismos</title>
    <link rel="icon" href="../ICONOS/LogoSistema.png" type="image/png">
    <link rel="stylesheet" href="../CSS/modificarorganismos.css">
</head>

<body>
    <header class="header">
        <a href="javascript:history.back()" class="back-icon">
            <img src="../ICONOS/icons8-left-2-50.png" alt="Regresar" class="icon">
        </a>
        <h1>Gesti√≥n Biol√≥gica de Suelos</h1>
    </header>

    <div class="container">
        <h1>Organismos</h1>
        <table>
            <thead>
                <tr>
                    <th>ID Detalle</th>
                    <th>ID Organismo</th>
                    <th>Nombre Organismo</th>
                    <th>ID Muestra</th>
                    <th>Modificar</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="tablaDetallesMuestras">
                <!-- Filas din√°micas aqu√≠ -->
            </tbody>
        </table>
    </div>
    <div class="container">
        <h1>Plantas</h1>
        <table>
            <thead>
                <tr>
                    <th>ID Detalle</th>
                    <th>ID Muestra</th>
                    <th>ID Planta</th>
                    <th>ID Tipo Planta</th>
                    <th>Nombre Planta</th>
                    <th>Modificar</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="tablaPlantas">
                <!-- Filas din√°micas aqu√≠ -->
            </tbody>
        </table>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 1Ô∏è‚É£ Obtener el ID de la muestra desde la URL
            const urlParams = new URLSearchParams(window.location.search);
            const idMuestra = urlParams.get('id');

            if (!idMuestra) {
                alert('‚ùå Error: No se proporcion√≥ un ID de muestra.');
                return;
            }

            try {
                // 2Ô∏è‚É£ Hacer la petici√≥n para obtener los detalles de muestra filtrados por usuario y muestra
                const response = await fetch(`/listadetalles/${idMuestra}`);

                if (!response.ok) {
                    const error = await response.json();
                    console.error('‚ö†Ô∏è Error del servidor:', error);
                    alert('Error: ' + (error.error || 'No se pudieron cargar los detalles.'));
                    return;
                }

                const detalles = await response.json();

                if (detalles.length === 0) {
                    alert('‚ö†Ô∏è No hay detalles de muestras disponibles.');
                    return;
                }

                // 3Ô∏è‚É£ Mostrar los detalles en la tabla
                const tabla = document.getElementById('tablaDetallesMuestras');
                detalles.forEach((detalle) => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
        <td>${detalle.id_detalle}</td>
        <td>${detalle.id_organismo}</td>
        <td>${detalle.organismo_nombre}</td>
        <td>${detalle.id_muestra}</td>
        <td><button onclick="modificar('${detalle.id_organismo}')">Modificar</button></td>
        <td><button onclick="eliminar('${detalle.id_detalle}')">Eliminar</button></td>
    `;
                    tabla.appendChild(fila);
                });


            } catch (error) {
                console.error('‚ùå Error al cargar los detalles de muestra:', error);
                alert('Hubo un error al cargar los detalles.');
            }
        });


        function modificar(idOrganismo) {
            const urlParams = new URLSearchParams(window.location.search);
            const idMuestra = urlParams.get("id"); // Obtener el ID de la muestra de la URL

            if (!idMuestra) {
                alert("‚ö†Ô∏è No se proporcion√≥ un ID de muestra.");
                return;
            }

            // Redirigir a actualizarOrganismo.html con idMuestra e idOrganismo
            window.location.href = `/actualizarOrganismo.html?id=${idOrganismo}&idMuestra=${idMuestra}`;
        }



        async function eliminar(id) {
            console.log("üõ†Ô∏è Intentando eliminar el detalle con ID:", id); // üëà Agrega esta l√≠nea para verificar el ID

            const confirmacion = confirm("‚ö†Ô∏è ¬øSeguro que deseas eliminar este detalle de muestra?");
            if (!confirmacion) return;

            try {
                const response = await fetch(`/eliminardetalle/${encodeURIComponent(id)}`, { method: 'DELETE' });

                if (response.ok) {
                    alert('‚úÖ Detalle eliminado correctamente.');
                    location.reload();
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå Error: ${errorData.error || 'No se pudo eliminar el detalle.'}`);
                }
            } catch (error) {
                console.error('‚ùå Error al eliminar el detalle:', error);
                alert('Hubo un error al eliminar el detalle.');
            }
        }


    </script>



</body>

</html>